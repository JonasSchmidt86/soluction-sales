<br>
<div id="layoutAuthentication_content">
  <div class="card-body">
    <div class="row justify-content-center">
      <div>
        <div class="card mb-3" >
          <div class="card-header bg-primary" >
            <div class="d-flex">
              <h4 class="text-center font-weight-light">
                <%= "#{action_message} Produto"%>
              </h4>
              <%= link_to '', collaborators_backoffice_produto_imagens_path, class:'btn btn-close ms-auto' %>
            </div>
          </div>
          <div class="card-body">
            <div class="tab-content">
              <div class="tab-pane active" id="home" role="tabpanel" aria-labelledby="home-tab" tabindex="0">
                <div class="card-body">
                  <%= form_with(url: collaborators_backoffice_produto_imagens_path, local: true, method: :post, 
                                    class:"col dataTable-search") do |form| %>
                    <div class="row mb-3">
                      <div class="row mb-3">
                        <div class="d-flex align-items-center w-100">
                          <div class="form-floating me-2 flex-grow-1" style="position: relative;">
                            <%# form.hidden_field :cod_produto %>
                            <%= form.text_field :nome, class: "form-control produto_search", placeholder: "Selecione o produto!", id: "nome_produto" %>
                            <%= form.label :nome, "Produto" %>
                            <div id="products_list" class="position-absolute bg-light rounded form-control-md p-2 mt-2" style="display: none; z-index: 100; width: 100%;"></div>
                          </div>
                        </div>
                      </div>
                      <hr class="my-2">
                      <div class="row mb-3">
                        <div class="col-md-2">
                          <div class="form-floating mb-3 mb-md-0">
                            <%= form.text_field :cod_produto, readonly: true, value: (@produto.blank? ? nil : @produto.cod_produto), class: "text form-control", placeholder:"Codigo", id:"text" %>
                            <%= form.label :codigo_produto, class:"" %>
                          </div>
                        </div>
                        <div class="col-md-4">
                          <div class="form-floating mb-3 mb-md-0">
                            <%= form.collection_select(:cod_cor, ((@produto.nil?) ? Core.all : Core.where("cod_cor in (select DISTINCT cod_cor from empresaproduto where cod_produto = ?  and cod_empresa = ?)", @produto.cod_produto, current_collaborator.cod_empresa ).order(:cod_cor) ), :cod_cor, :nmcor_cod,
                                                        {:prompt => 'Selecione uma Cor'}, {class: "form-control", id: "select_cor"}) %>
                            <%= form.label :Cores, class:"" %>
                          </div>
                        </div>
                        <div class="col-md-6">
                          <div class="form-floating">
                            <%= form.text_field :nome, disabled: true, value: (!@produto.blank? ? @produto.nome : nil), class: "text form-control", placeholder:"Produto", id:"text" %>
                            <%= form.label :name, class:"" %>
                          </div>
                        </div>
                        <div class="col-md-6">
                          <%= form.label :valor_site, "Valor" %>
                          <%= form.text_field :valor_site, class: "money2 form-control", id: "campo_valor_site" %>
                        </div>
                        <div class="form-group">
                          <%= form.label :descricao, "Descri√ß√£o" %>
                          <%= form.text_area :descricao, class: "form-control", rows: 3, id: "campo_descricao" %>
                        </div>
                        <div class="form-group">
                          <div class="form-check">
                            <%= form.check_box :publicado, class: "form-check-input", id: "campo_publicado" %>
                            <%= form.label :publicado, "Publicado", class: "form-check-label" %>
                          </div>
                        </div>
                      </div>
                      <hr class="my-2">
                      <div class="row mb-3">
                        <div class="row g-2 align-items-end">
                          <div class="col-md-9">
                            <div class="h-100">
                              <%= form.file_field :imagens, multiple: true, class: "form-control" %>
                            </div>
                          </div>
                          <div class="col-md-3 d-flex align-items-end">
                            <%= form.hidden_field :path, value: 'edit' %>
                            <button type="submit" class="btn btn-success w-100">Salvar</button>
                          </div>
                        </div>
                        <div class="d-flex flex-wrap gap-3 mt-3">
                          <% (@produto_imagens || []).each_with_index do |imagem, index| %>
                            <div class="position-relative image-container" style="display: inline-block;">
                              <div class="dropdown position-relative">
                                <button class="btn p-0 border-0 imagem-botao"
                                        data-index="<%= index %>"
                                        type="button" 
                                        data-bs-toggle="dropdown" 
                                        data-bs-popper="none"
                                        aria-expanded="false" 
                                        style="position: relative; caret-color: transparent;">
                                  <%= image_tag(imagem.imagem, 
                                    class: "d-block w-100 rounded", 
                                    style: "max-width: 220px; height: 180px; object-fit: contain;" 
                                  ) %>
                                </button>
                                <ul class="dropdown-menu position-absolute" 
                                  style="top: 10px; left: 50%; transform: translateX(-50%); z-index: 10;" aria-labelledby="imageDropdown">
                                  <li>
                                    <button class="open-modal dropdown-item" 
                                      id="abrir-modal-imagens_<%= index %>" 
                                      type="button" 
                                      data-bs-toggle="modal" 
                                      data-bs-target="#imageModal" 
                                      data-index="<%= index %>"
                                      data-produto-id="<%= (!@produto.blank? ? @produto.id : nil) %>"
                                      >
                                      üîç Ampliar
                                    </button>
                                  </li>
                                  <li>
                                    <button class="open-modal dropdown-item" 
                                      type="button" 
                                      data-bs-toggle="modal" 
                                      data-bs-target="#produto_info" 
                                      data-index="<%= imagem.produto.id %>"
                                      data-produto-id="<%= imagem.produto.id %>"
                                      data-produto-nome="<%= (!@produto.blank? ? @produto.nome : nil) %>" >
                                      ‚ÑπÔ∏è Informa√ß√µes
                                    </button>
                                  </li>
                                  <li>
                                    <%= link_to "üóëÔ∏è Remover", collaborators_backoffice_produto_imagen_path(id: imagem, term:"path_edit"), 
                                      method: :delete, 
                                      data: { confirm: "Tem certeza de que deseja remover esta imagem?" },
                                      class: "dropdown-item text-danger"
                                    %>
                                  </li>
                                </ul>
                              </div>
                            </div>
                          <% end %>
                        </div>
                      </div>
                    <% end %>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
<script>
  document.addEventListener('DOMContentLoaded', function() {
    const selectCor = document.getElementById('select_cor');
    const codProdutoField = document.querySelector('input[name="cod_produto"]');

    if (selectCor && codProdutoField) {

      selectCor.addEventListener('change', function() {

        const codCor = this.value;
        const codProduto = codProdutoField.value;

        if (codCor && codProduto) {

          fetch(`<%= get_cor_data_collaborators_backoffice_produto_imagens_path %>?cod_produto=${codProduto}&cod_cor=${codCor}`)
            .then(response => response.json())
            .then(data => {
              if (data.error) {
                console.error('Erro:', data.error);
              } else {
                // Preenche os campos com os dados da cor

                document.getElementById('campo_valor_site').value = parseFloat(data.valor_site).toFixed(2).replace(".",",") || '';
                document.getElementById('campo_descricao').value = data.descricao || '';
                document.getElementById('campo_publicado').checked = data.publicado || false;
              }
            })
            .catch(error => {
              console.error('Erro na requisi√ß√£o:', error);
            });
        }
      });
    }
  });
</script>