<div class="card mt-3">
  <%= link_to collaborators_backoffice_report_rep_dre_index_path, class:"card-header bg-primary" do %>
    <h4>DRE - Demonstrativo de Resultados</h4>
  <% end %>
  <div class="card-body">
    <%= form_with(url: collaborators_backoffice_report_rep_dre_index_path, local: true, method: :get, class:"col dataTable-search") do |form| %>
      <div class="d-flex mb-2 col-md-6">
        <div class="col-md-2">
          <%= form.text_field :dataInicial, value: ((!(params[:dataInicial]).blank? ? params[:dataInicial] : Time.current.strftime("01/%m/%Y")  )),
                    class: "fallback dataTable-input datepicker", placeholder:"Data Inicial" %>
        </div>
        <div class="col-md-2">
          <%= form.text_field :dataFinal, value: ((!(params[:dataFinal]).blank? ? params[:dataFinal] : Date.today.end_of_month.strftime("%d/%m/%Y")  )),
                    class: "fallback dataTable-input datepicker", placeholder:"Data Final" %>
        </div>
        <div class="me-4 col-md-1">
          <button type='submit', class="btn btn-success btn-circle">Buscar</button>
        </div>
      </div>
    <% end %>
    <%# form  acima %>
    <% @vendas.each do |mes| %>
      <% mes_formatado = mes.mes %>
      <% lucro_bruto = mes.receita_bruta.to_f - mes.custo_total.to_f %>
      <table class="table table-bordered ">
        <tr>
          <th>Receita Bruta - <%= Date.new(2023, mes.mes.to_i).strftime("%B") %></th>
          <td><%= number_to_currency(mes.receita_bruta, unit: "R$ ", format: "%u%n") %></td>
        </tr>
        <tr>
          <th>Custo dos Produtos Vendidos</th>
          <td><%= number_to_currency(mes.custo_total, unit: "R$ ", format: "%u%n") %></td>
        </tr>
        <tr>
          <th>Lucro Bruto</th>
          <td><strong><%= number_to_currency(lucro_bruto, unit: "R$ ", format: "%u%n") %></strong></td>
        </tr>
      </tbody>
    </table>
    <% lancamentos_do_mes = @lancamentos.select { |l| l[0]. != mes.mes } %>
    <% if lancamentos_do_mes.any? %>
      <h5>Outras Receitas e Despesas</h5>
      <table class="table table-sm table-striped table-bordered">
        <thead>
          <tr>
            <th>Histórico</th>
            <th>Tipo</th>
            <th>Valor</th>
          </tr>
        </thead>
        <tbody>
          <% total_outros = 0 %>
          <% total_entradas = 0 %>
          <% total_saidas = 0 %>
          <% lancamentos_do_mes.each do |lc| %>
            <% if lc.mes.to_i == mes.mes.to_i%>
              <% total ||= 0 %>
              <% total_outros += (lc.tipo == 'E' ? lc.total : -lc.total) %>
              <% total_entradas += (lc.tipo == 'E' ? lc.total : 0) %>
              <% total_saidas += (lc.tipo == 'S' ? lc.total : 0) %>
              <tr>
                <td><%= lc.descricao %></td>
                <td><%= lc.tipo == 'E' ? 'Receita' : 'Despesa' %></td>
                <td><%= number_to_currency(lc.total, unit: "R$ ", format: "%u%n") %></td>
              </tr>
            <% end %>
          <% end %>
          <tr class="table-secondary">
            <th colspan="2">Entradas</th>
            <th><%= number_to_currency( total_entradas, unit: "R$ ", format: "%u%n") %></th>
          </tr>
          <tr class="table-secondary">
            <th colspan="2">Saidas</th>
            <th><%= number_to_currency( total_saidas, unit: "R$ ", format: "%u%n") %></th>
          </tr>
          <tr class="table-secondary">
            <th colspan="2">Resultado Operacional</th>
            <th><%= number_to_currency( total_outros, unit: "R$ ", format: "%u%n") %></th>
          </tr>
        </tbody>
      </table>
    <% else %>
      <p class="text-muted">Sem outras receitas ou despesas neste mês.</p>
    <% end %>
  <% end %>
</div>
</div>