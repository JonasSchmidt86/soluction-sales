<div class="card mt-3">
  <%= link_to '#', class:"card-header bg-primary" do %>
    <h4 ><%= @report.title %></h4>
  <% end %>
  <div class="card-body">
    <% if current_collaborator.funcionario.permissao.nivel == 1 && current_collaborator.funcionario.cod_funcionario == 1 %>
      <%= link_to edit_collaborators_backoffice_report_custom_report_path( @report.id), class:"btn btn-info btn-circle", data: {confirm: "Deseja Editar?"} do %>
        <i class="fa fa-edit", style="width: 35px;"></i> Editar Relatório
      <% end %>
    <% end %>
    <h5 class="mt-3">
      <p class="text-muted"><%= @report.description %></p>
    </h5>
    <%= form_with url: run_collaborators_backoffice_report_custom_report_path(@report), method: :get, local: true, class: "row gx-3 gy-2 align-items-end mt-4" do |form| %>
      <% @report.sql_code.scan(/{{(.*?)}}/).flatten.uniq.each do |param| %>
        <% field_name = param.strip.downcase %>
        <% if field_name == 'inicio' %>
          <div class="col-auto">
            <%= form.label :inicio, "Data Inicial", class: "form-label" %>
            <%= form.text_field :inicio, value: (params[:inicio].presence || Time.now.strftime("%d/%m/%Y")),
              class: "form-control datepicker fallback", style: "width: 140px;" %>
          </div>
        <% elsif field_name == 'fim' %>
          <div class="col-auto">
            <%= form.label :fim, "Data Final", class: "form-label" %>
            <%= form.text_field :fim, value: (params[:fim].presence || Time.now.strftime("%d/%m/%Y")),
              class: "form-control datepicker fallback", style: "width: 140px;" %>
          </div>
        <% elsif %>
          <div class="col-auto">
            <%= form.label :fim, "Data Final", class: "form-label" %>
            <%= form.text_field :fim, value: (params[:fim].presence || Time.now.strftime("%d/%m/%Y")),
              class: "form-control datepicker fallback", style: "width: 140px;" %>
          </div>
        <% else %>
          <div class="col-auto">
            <%= label_tag param, param.humanize, class: "form-label" %>
            <%= text_field_tag param, params[param], class: "form-control", placeholder: param.humanize, style: "width: 180px;", required: true %>
          </div>
        <% end %>
      <% end %>
      <div class="col-auto">
        <%= submit_tag "Executar Relatório", class: "btn btn-primary" %>
      </div>
    <% end %>
    <% if @results.present? %>
      <div class="table-responsive mt-3">
        <table class="table table-bordered table-striped table-sm">
          <thead class="table-light">
            <tr>
              <th><%=  %></th>
              <% @results.columns.each do |col| %>
                <th><%= col.titleize %></th>
              <% end %>
            </tr>
          </thead>
          <tbody>
            <% i = 0 %>
            <% @results.rows.each do |row| %>
              <% i = i+1 %>
              <tr>
                <td>
                  <%= i  %>
                </td>
                <% row.each do |value| %>
                  <td><%= value %></td>
                <% end %>
              </tr>
            <% end %>
          </tbody>
        </table>
        <%= link_to "Exportar para Excel",
          run_collaborators_backoffice_report_custom_report_path(@report, request.query_parameters.merge(format: :xlsx)),
          target: "download_target",
          id: "btn_download_excel",
          class: "btn btn-success mt-3" %>
        <iframe id="download_frame" name="download_frame" style="display:none;"></iframe>
        <div class="alert alert-danger mt-3">
          <strong>Quantidade:</strong> <%= @results.length %>
        </div>
      </div>
    <% elsif @error.present? %>
      <div class="alert alert-danger mt-3">
        <strong>Erro:</strong> <%= @error %>
      </div>
    <% end %>
  </div>
</div>
